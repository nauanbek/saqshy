# Test infrastructure services for SAQSHY
#
# These containers run on different ports to avoid conflicts with dev environment.
# Usage: docker compose -f docker/docker-compose.test.yml up -d
#
# Ports:
#   - PostgreSQL: 5434 (vs 5433 for dev)
#   - Redis: 6380 (vs 6379 for dev)
#   - Qdrant: 6335/6336 (vs 6333/6334 for dev)

services:
  postgres-test:
    image: postgres:16-alpine
    container_name: saqshy-postgres-test
    ports:
      - "5434:5432"
    environment:
      POSTGRES_USER: saqshy_test
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: saqshy_test
    # Use tmpfs for faster tests (data is ephemeral anyway)
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U saqshy_test -d saqshy_test"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s
    # Optimize for testing (not durability)
    command: >
      postgres
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off
      -c random_page_cost=1.0

  redis-test:
    image: redis:7-alpine
    container_name: saqshy-redis-test
    ports:
      - "6380:6379"
    # No persistence for tests
    command: redis-server --appendonly no --save ""
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 5s
      retries: 10

  qdrant-test:
    image: qdrant/qdrant:latest
    container_name: saqshy-qdrant-test
    ports:
      - "6335:6333"  # HTTP REST API
      - "6336:6334"  # gRPC
    environment:
      QDRANT__SERVICE__GRPC_PORT: "6334"
      QDRANT__LOG_LEVEL: "WARN"
    # Use tmpfs for faster tests
    tmpfs:
      - /qdrant/storage

networks:
  default:
    name: saqshy-test
